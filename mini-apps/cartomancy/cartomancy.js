import FortuneEngine from"../../engine.js";import setMusicState from"../../autoplay.js";const engine=new FortuneEngine,APP_NAME="cartomancy";let cardsPicked=0,i=0,targetName,sourceContainerID="",droppedID="";const card1s=document.querySelectorAll(".card1"),card2s=document.querySelectorAll(".card2"),card3s=document.querySelectorAll(".card3"),pickContainer1=document.getElementById("pick-container1"),pickContainer2=document.getElementById("pick-container2"),pickContainer3=document.getElementById("pick-container3"),cardPlaced=new Audio("../../assets/cart/bgm-side.wav"),clickedButton=new Audio("../../assets/cart/cartomancy-click-sound.mp3"),card1sArray=Array.from(card1s),card2sArray=Array.from(card2s),card3sArray=Array.from(card3s),musicImage=(card1s.forEach(e=>{e.addEventListener("dragstart",dragStart)}),card2s.forEach(e=>{e.addEventListener("dragstart",dragStart)}),card3s.forEach(e=>{e.addEventListener("dragstart",dragStart)}),pickContainer1.addEventListener("drop",dropped),pickContainer2.addEventListener("drop",dropped),pickContainer3.addEventListener("drop",dropped),pickContainer1.addEventListener("dragenter",cancelDefault),pickContainer1.addEventListener("dragover",cancelDefault),pickContainer2.addEventListener("dragenter",cancelDefault),pickContainer2.addEventListener("dragover",cancelDefault),pickContainer3.addEventListener("dragenter",cancelDefault),pickContainer3.addEventListener("dragover",cancelDefault),document.getElementById("music"));function cancelDefault(e){return e.preventDefault(),e.stopPropagation(),!1}function dragStart(e){e.dataTransfer.setData("text/plain",e.target.id),sourceContainerID=this.parentElement.className,droppedID=this.className}function dropped(e){var t;targetName=e.target.id,this.id!==sourceContainerID&&(cancelDefault(e),"card1"===droppedID?((t=card1sArray[i]).style.animation="flip 2s ease",e.target.appendChild(card1sArray[i]),cardPlaced.play(),t.draggable=!1,cardsPicked++,i++):"card2"===droppedID?((t=card2sArray[i]).style.animation="flip 2s ease",e.target.appendChild(card2sArray[i]),cardPlaced.play(),t.draggable=!1,cardsPicked++,i++):"card3"===droppedID&&((t=card3sArray[i]).style.animation="flip 2s ease",e.target.appendChild(card3sArray[i]),cardPlaced.play(),t.draggable=!1,cardsPicked++,i++),0<pickContainer1.children.length&&(pickContainer1.style.userSelect="none",pickContainer1.style.pointerEvents="none"),0<pickContainer2.children.length&&(pickContainer2.style.userSelect="none",pickContainer2.style.pointerEvents="none"),0<pickContainer3.children.length)&&(pickContainer3.style.userSelect="none",pickContainer3.style.pointerEvents="none"),1===cardsPicked&&(document.querySelector("#reset-button").style.display="flex"),3===cardsPicked&&(document.querySelectorAll(".read-fortune-space")[0].style.display="flex")}function readCards(e){e.classList.add("container"),document.getElementById("read-fortune-button").style.display="none";var t=engine.get_random_subset(3);for(let e=1;e<4;e++)organizeCards(document.getElementById("pick-container"+e),t[e-1])}function organizeCards(e,t){e.removeChild(e.firstChild),e.classList.remove("pick-container"),e.classList.add("read-container");var n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("img"),i=document.createElement("div"),d=document.createElement("p"),c=document.createTextNode(t.result);d.classList.add("read-fortune"),n.classList.add("card-show"),a.classList.add("image"),r.setAttribute("href","#"),r.setAttribute("src",`../../assets/cart/${t.image}.png`),i.classList.add("content"),d.appendChild(c),n.appendChild(a),a.appendChild(r),i.appendChild(c),n.appendChild(i),e.appendChild(n)}document.addEventListener("DOMContentLoaded",async()=>{await engine.db_reader(`./${APP_NAME}.json`);const t=new Audio("../../assets/cart/bgm-background.mp3");t.loop=!0,t.play().then(()=>{}).catch(()=>{n=!1,setMusicState(t,musicImage,n)});let n=!0,a=!1;var e=document.getElementById("music-button"),r=document.getElementById("info-button"),i=document.getElementById("read-fortune-button"),d=document.getElementById("start-button");const c=document.getElementById("card-display"),s=document.getElementById("center-div");d.addEventListener("click",e=>{clickedButton.playbackRate=2.5,clickedButton.play(),document.getElementById("intro").style.display="none",c.style.display="initial",document.getElementById("start-button").style.display="none",pickContainer1.style.display="flex",pickContainer2.style.display="flex",pickContainer3.style.display="flex"}),i.addEventListener("click",e=>{clickedButton.playbackRate=2.5,clickedButton.play(),pickContainer1.style.userSelect="auto",pickContainer1.style.pointerEvents="auto",pickContainer2.style.userSelect="auto",pickContainer2.style.pointerEvents="auto",pickContainer3.style.userSelect="auto",pickContainer3.style.pointerEvents="auto",document.getElementById("reset-button").style.visibility="visible",pickContainer1.style.animation="shrink 1s ease",pickContainer2.style.animation="shrink 1s ease",pickContainer3.style.animation="shrink 1s ease",c.classList.add("hide-cards"),setTimeout(()=>{c.remove(),pickContainer1.style.animation="grow 2s ease",pickContainer2.style.animation="grow 2s ease",pickContainer3.style.animation="grow 2s ease",readCards(s)},1e3)}),e.addEventListener("click",e=>{n=setMusicState(t,musicImage,!n)}),r.addEventListener("click",e=>{document.getElementById("info-popup").style.display=a?"none":"flex",a=!a}),document.getElementById("reset-button").addEventListener("click",e=>{clickedButton.play(),window.location.reload()})});
